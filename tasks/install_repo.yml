---
- name: "Repo install tasks"
  when: (not __installed_bin.stat.exists) or elasticsearch_install_force
  block:
    - name: "Debian tasks"
      when: ansible_os_family == 'Debian'
      block:
        - name: "DEBIAN | Ensure dependencies are installed."
          ansible.builtin.package:
            name:
              - apt-transport-https
              - gnupg2
            state: present
          register: __pkg_result
          retries: 12
          delay: 10
          until: __pkg_result is success
          when: ansible_os_family == 'Debian'

        - name: "DEBIAN | Add Elasticsearch GPG key"
          ansible.builtin.get_url:
            url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
            dest: /usr/share/keyrings/elasticsearch.asc
            mode: '0644'

        - name: "DEBIAN | Add Elasticsearch apt repository"
          ansible.builtin.apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/elasticsearch.asc] https://artifacts.elastic.co/packages/{{ elasticsearch_major }}/apt stable main"
            state: present
            filename: elasticsearch
            update_cache: true

        - name: "Install elasticsearch."
          ansible.builtin.package:
            name: "elasticsearch"
            state: present
            force: "yes"
          register: __pkg_result
          retries: 12
          delay: 10
          until: __pkg_result is success

            #    - name: "Change file ownership, group and permissions"
            #      ansible.builtin.file:
            #        path: "{{ item }}"
            #        owner: "{{ elasticsearch_user }}"
            #        group: "{{ elasticsearch_group }}"
            #        mode: "0755"
            #        recurse: true
            #      loop:
            #        - "{{ elasticsearch_install_dir }}"
